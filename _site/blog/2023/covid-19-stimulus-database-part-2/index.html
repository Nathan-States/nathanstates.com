<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Nathan States">
<meta name="dcterms.date" content="2023-02-02">
<meta name="description" content="Using the power of big data to compress 140GB of data to less than 10GB.">

<title>Nathan States - Building a COVID-19 Economic Relief Database: Part 2 (Apache Arrow)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="../../../assets/styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">nathan<span class="icon-line"></span>states_</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../projects.html">
 <span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../archives.html">
 <span class="menu-text">Archives</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../notes.html">
 <span class="menu-text">Notes</span></a>
  </li>  
</ul>
              <div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Building a COVID-19 Economic Relief Database: Part 2 (Apache Arrow)</h1>
                  <div>
        <div class="description">
          Using the power of big data to compress 140GB of data to less than 10GB.
        </div>
      </div>
                </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Nathan States </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 2, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>A quick recap of the last post.</p>
<ul>
<li>We’ve now downloaded the compressed database from usaspending.gov and have it stored locally onto our computer.</li>
<li>We need to group the data by each <code>award_unique_key</code>. However, the data is spread across 139 different files, each one being over a giga-byte big, totaling over 140GB.</li>
<li><code>R</code> stores datasets into RAM, which means we need over 140GB of RAM to perform computations. No commercial computer comes with that much memory, so how do we go about importing the dataset.</li>
</ul>
<p>That’s where <strong>Apache Arrow</strong> comes in.</p>
<p><img src="thumbnail.png" class="preview-image img-fluid"></p>
<section id="quick-rundown" class="level2">
<h2 class="anchored" data-anchor-id="quick-rundown">Quick Rundown</h2>
<p><em>Arrow</em> comes from the <a href="https://www.apache.org/">Apache Software Foundation</a>, who releases free and open source tools for software engineers and data scientists. The package was written using C++, and is available in a variety of programming languages, including Python. What’s cool about this is that improvements made to the underlying code will improve performance across all languages as opposed to only one. You can download the <code>R</code> version by running:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"arrow"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Arrow isn’t specifically meant to be a solution for big data, but rather, <strong>it’s an attempt to standardize data formatting across programming languages</strong>. It uses a special file type called <em>parquet</em> for storing data, which is designed to take advantage of modern CPU and GPU capabilities, meaning it can perform operations on billions of rows of data within seconds. Other packages - even <code>data.table</code> - can’t compete.</p>
<p><code>data.table</code> was considered to be the fastest package at performing computations before Arrow, but it relied on the original framework <code>R</code> used when it was created in 1995. For most modern computers, Arrow should be even faster in the vast majority of use cases. Furthermore, unlike <code>data.table</code>, <em>Arrow</em> can understand <code>dplyr</code> language perfectly fine, which means you don’t need to learn a different syntax when data wrangling.</p>
<p>There is, essentially, no reason not to use Arrow. It’s simply superior to other options. With that said, <em>Arrow</em> will only offer milliseconds of improvement for dataframes under 10,000 rows, which is why it’s usually reserved for big data problems only.</p>
</section>
<section id="arrow-setup" class="level2">
<h2 class="anchored" data-anchor-id="arrow-setup">Arrow Setup</h2>
<p>Let’s quickly load the packages that we need.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arrow)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'arrow'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    timestamp</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>here<span class="sc">::</span><span class="fu">set_here</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>File .here already exists in C:\Github_Repositories\nathan-states\blog\2023\covid-19-stimulus-database-part-2</code></pre>
</div>
</div>
<p>I have all 139 files stored locally in a folder called “covid-files,” which we now want to import. Instead of calling the file name, Arrow allows us to call the <em>directory</em> to load the files all together.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"_dummy_data"</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"csv"</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we didn’t <em>actually</em> load all the data, because that would break the laws of computer hardware. All we did is load the <em>metadata</em>, or the <strong>data about our data</strong>. We can see this by calling <code>df</code>, which normally would display a spreadsheet, but in this case, gives us the <strong>assumed schema</strong> of our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>FileSystemDataset with 1 csv file
owning_agency_name: string
reporting_agency_name: string
submission_period: string
allocation_transfer_agency_identifier_code: int64
agency_identifier_code: int64
beginning_period_of_availability: null
ending_period_of_availability: null
availability_type_code: string
main_account_code: int64
sub_account_code: int64
treasury_account_symbol: string
treasury_account_name: string
agency_identifier_name: string
allocation_transfer_agency_identifier_name: null
budget_function: string
budget_subfunction: string
federal_account_symbol: string
federal_account_name: string
program_activity_code: int64
program_activity_name: string
object_class_code: int64
object_class_name: string
direct_or_reimbursable_funding_source: string
disaster_emergency_fund_code: string
disaster_emergency_fund_name: string
transaction_obligated_amount: double
gross_outlay_amount_FYB_to_period_end: double
USSGL487200_downward_adj_prior_year_prepaid_undeliv_order_oblig: null
USSGL497200_downward_adj_of_prior_year_paid_deliv_orders_oblig: null
award_unique_key: string
award_id_piid: null
parent_award_id_piid: null
award_id_fain: int64
award_id_uri: null
award_base_action_date: string
award_base_action_date_fiscal_year: int64
award_latest_action_date: string
award_latest_action_date_fiscal_year: int64
period_of_performance_start_date: null
period_of_performance_current_end_date: null
ordering_period_end_date: null
award_type_code: int64
award_type: string
idv_type_code: null
idv_type: null
prime_award_base_transaction_description: string
awarding_agency_code: int64
awarding_agency_name: string
awarding_subagency_code: int64
awarding_subagency_name: string
awarding_office_code: int64
awarding_office_name: string
funding_agency_code: int64
funding_agency_name: string
funding_sub_agency_code: int64
funding_sub_agency_name: string
funding_office_code: int64
funding_office_name: string
recipient_uei: null
recipient_duns: null
recipient_name: string
recipient_parent_uei: null
recipient_parent_duns: null
recipient_parent_name: null
recipient_country: string
recipient_state: string
recipient_county: string
recipient_city: string
recipient_congressional_district: int64
recipient_zip_code: int64
primary_place_of_performance_country: string
primary_place_of_performance_state: string
primary_place_of_performance_county: string
primary_place_of_performance_congressional_district: int64
primary_place_of_performance_zip_code: int64
cfda_number: double
cfda_title: string
product_or_service_code: null
product_or_service_code_description: null
naics_code: null
naics_description: null
national_interest_action_code: null
national_interest_action: null
usaspending_permalink: string
last_modified_date: string</code></pre>
</div>
</div>
<p>I included a demo spreadsheet for this post that contains 20 rows from one of the datasets, including all the original columns, in case you are wondering why only 1 csv file was read. If you are doing this with the original dataset, you will of course have many more files, but the concept is the same in both cases.</p>
<p>Looking at the schema, some of the columns need to be changed to their correct data type. This should be straightforward for most programmers, but something to keep in mind when using <em>Arrow</em> specifically is that they differentiate between bit sizes. This means that if you were trying to run computations on a column with a <code>int64</code> datatype on a Windows 32-bit computer, you’d run into errors because <em>Arrow</em> would be trying to take advantage of computing power that doesn’t exist. If you don’t know what any of that means, there is a 99.99% chance you are running a 64 bit computer, in which case you will want to set all data types to that format.</p>
<p>We’ll use the <code>schema</code> function to denote our fixed data types and reread in the data. When including a schema, you also have to skip the first row for some reason, so we’ll make sure to do that.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>schema_fix <span class="ot">&lt;-</span> <span class="fu">schema</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">owning_agency_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">reporting_agency_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">submission_period =</span> <span class="fu">string</span>(),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">allocation_transfer_agency_identifier_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">agency_identifier_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">beginning_period_of_availability =</span> <span class="fu">double</span>(),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ending_period_of_availability =</span> <span class="fu">double</span>(),</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">availability_type_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">main_account_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">sub_account_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">treasury_account_symbol =</span> <span class="fu">string</span>(),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">treasury_account_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">agency_identifier_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">allocation_transfer_agency_identifier_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">budget_function =</span> <span class="fu">string</span>(),</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">budget_subfunction =</span> <span class="fu">string</span>(),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">federal_account_symbol =</span> <span class="fu">string</span>(),</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">federal_account_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">program_activity_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">program_activity_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">object_class_code =</span> <span class="fu">double</span>(),</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">object_class_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">direct_or_reimbursable_funding_source =</span> <span class="fu">string</span>(),</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">disaster_emergency_fund_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">disaster_emergency_fund_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">transaction_obligated_amount =</span> <span class="fu">double</span>(),</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">gross_outlay_amount_FYB_to_period_end =</span> <span class="fu">double</span>(),</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">USSGL487200_downward_adj_prior_year_prepaid_undeliv_order_oblig =</span> <span class="fu">double</span>(),</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">USSGL497200_downward_adj_of_prior_year_paid_deliv_orders_oblig =</span> <span class="fu">double</span>(),</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_unique_key =</span> <span class="fu">string</span>(),</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_id_piid =</span> <span class="fu">string</span>(),</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">parent_award_id_piid =</span> <span class="fu">string</span>(),</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_id_fain =</span> <span class="fu">string</span>(),</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_id_uri =</span> <span class="fu">string</span>(),</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_base_action_date =</span> <span class="fu">date64</span>(),</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_base_action_date_fiscal_year =</span> <span class="fu">double</span>(),</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_latest_action_date =</span> <span class="fu">date64</span>(),</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_latest_action_date_fiscal_year =</span> <span class="fu">double</span>(),</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">period_of_performance_start_date =</span> <span class="fu">date64</span>(),</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">period_of_performance_current_end_date =</span> <span class="fu">date64</span>(),</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">ordering_period_end_date =</span> <span class="fu">date64</span>(),</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_type_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">award_type =</span> <span class="fu">string</span>(),</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">idv_type_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">idv_type =</span> <span class="fu">string</span>(),</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">prime_award_base_transaction_description =</span> <span class="fu">string</span>(),</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">awarding_agency_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">awarding_agency_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">awarding_subagency_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">awarding_subagency_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">awarding_office_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">awarding_office_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">funding_agency_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">funding_agency_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">funding_sub_agency_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">funding_sub_agency_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">funding_office_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">funding_office_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_uei =</span> <span class="fu">string</span>(),</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_duns =</span> <span class="fu">string</span>(),</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_parent_uei =</span> <span class="fu">string</span>(),</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_parent_duns =</span> <span class="fu">string</span>(),</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_parent_name =</span> <span class="fu">string</span>(),</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_country =</span> <span class="fu">string</span>(),</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_state =</span> <span class="fu">string</span>(),</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_county =</span> <span class="fu">string</span>(),</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_city =</span> <span class="fu">string</span>(),</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_congressional_district =</span> <span class="fu">string</span>(),</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">recipient_zip_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_place_of_performance_country =</span> <span class="fu">string</span>(),</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_place_of_performance_state =</span> <span class="fu">string</span>(),</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_place_of_performance_county =</span> <span class="fu">string</span>(),</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_place_of_performance_congressional_district =</span> <span class="fu">string</span>(),</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">primary_place_of_performance_zip_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">cfda_number =</span> <span class="fu">double</span>(),</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">cfda_title =</span> <span class="fu">string</span>(),</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">product_or_service_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">product_or_service_code_description =</span> <span class="fu">string</span>(),</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">naics_code =</span> <span class="fu">double</span>(),</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">naics_description =</span> <span class="fu">string</span>(),</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">national_interest_action_code =</span> <span class="fu">string</span>(),</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">national_interest_action =</span> <span class="fu">string</span>(),</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">usaspending_permalink =</span> <span class="fu">string</span>(),</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">last_modified_date =</span> <span class="fu">date64</span>()</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Import Data ----</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">open_dataset</span>(</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>  <span class="st">"_dummy_data"</span>, </span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">format =</span> <span class="st">"csv"</span>,</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">skip_rows =</span> <span class="dv">1</span>,</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">schema =</span> schema_fix</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It’s possible to do all the computations that we need to extract the information we want from here, including who the top recipients are, the congressional districts that received the most aid, award breakdowns by legislation, and so on. Still, I want to present this databse in a format that’s easy and usable to the general public, which is going to require some:</p>
</section>
<section id="data-wrangling" class="level2">
<h2 class="anchored" data-anchor-id="data-wrangling">Data Wrangling</h2>
<p>Even though there are a total of 85 columns, the majority of them are metadata pulled from other agencies that we don’t need. In terms of columns that need to be inspected, those include (with descriptions):</p>
<ul>
<li><code>owning_agency_name</code>: The agency the award comes from.</li>
<li><code>submission_period</code>: The year and month the award entry was submitted to usaspending.gov.</li>
<li><code>beginning_period_of_availability</code>: The year the award was first available.</li>
<li><code>ending_period_of_avaliability</code>: The year the award expires.</li>
<li><code>treasury_account_name</code>: The program name along with the subagency name.</li>
<li><code>budget_function</code>: General description of the award.</li>
<li><code>budget_subfunction</code>: Slightly more specific description of the award.</li>
<li><code>program_activity_name</code>: Name of the program.</li>
<li><code>direct_or_reimbursable_funding_source</code>:</li>
<li><code>disaster_emergency_fund_name</code>: CARES, ARPA, etc.</li>
<li><code>transaction_obligated_amount</code>: The amount the recipient was obligated to.</li>
<li><code>gross_outlay</code> and <code>USSGL</code> columns: Click <a href="">here</a> for more details.</li>
<li><code>award_type</code>: Whether the award was a grant, loan, contract, etc.</li>
<li><code>prime_award_base_transaction_description</code>: A more specific description of what the award is trying to accomplish.</li>
<li><code>award_office_name</code>: Office name from agency.</li>
<li><code>recipient_name</code>: Company who received the award.</li>
<li><code>recipient_parent_name</code>: Parent of the recipient, if available.</li>
<li><code>recipient_country/state/county/city/cd/zip_code</code>: All should be self explanatory. It should be noted that these represent the <em>facility</em> that received the award, and not the recipients <em>headquarters</em>.</li>
<li><code>cfda_title</code>: CFDA program name.</li>
<li><code>usaspending_permalink</code>: Source for award data.</li>
<li><code>last_modified_date</code>: Last time the entry was modified.</li>
</ul>
<p>All of these columns are going to have to be dealt with differently, so I’ll go through them one-by-one.</p>
<section id="preliminary-glance" class="level3">
<h3 class="anchored" data-anchor-id="preliminary-glance">Preliminary Glance</h3>
<p>Before we do that, let’s take a quick look to make sure there are no duplicates in the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When using arrow, you have to call <code>dplyr::collect</code> to get the results of the query, otherwise nothing will be collected.</p>
<p>Next, let’s see how many NAs there are in total to get an idea about how we might want to deal with them later on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span> <span class="fu">sum</span>(<span class="fu">is.na</span>(.)))) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<hr>
<p>The rest of this post will just be me transforming the data into a usable format. My next post will be converting it into a <code>PostgreSQL</code> database, and after that, we’ll actually analyze the data by creating some cool ass charts. Stay tuned.</p>
</section>
</section>
<section id="submission-period" class="level2">
<h2 class="anchored" data-anchor-id="submission-period">Submission Period</h2>
<p>These columns are written in the style of “FY2020P11,” where “FY” represents fiscal year and “P” represents the month. Representing this amount as “2020/11” not only is easier to read, but will for simple computations because its formatted as a proper date.</p>
<p>Using <code>dplyr</code> and <code>gsub</code> can easily replace the characters to transform the format into “YYYY-MM,” and <code>lubridate</code> can convert it the column into <code>datetime</code> type.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">submission_period =</span> <span class="fu">gsub</span>(<span class="st">"FY"</span>, <span class="st">""</span>, <span class="fu">as.character</span>(submission_period))) <span class="sc">%&gt;%</span> <span class="co"># Replace FY with blank space</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">submission_period =</span> <span class="fu">gsub</span>(<span class="st">"P"</span>, <span class="st">"-"</span>, <span class="fu">as.character</span>(submission_period))) <span class="sc">%&gt;%</span> <span class="co"># Replace P with -</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">submission_period =</span> lubridate<span class="sc">::</span><span class="fu">ym</span>(submission_period)) <span class="sc">%&gt;%</span> <span class="co"># Convert into datetime</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="award-types" class="level2">
<h2 class="anchored" data-anchor-id="award-types">Award Types</h2>
<p>There are several different award types within our dataset. We can view them all using <code>dplyr::summarise</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(award_type) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 x 2
  award_type                  count
  &lt;chr&gt;                       &lt;int&gt;
1 DIRECT LOAN (E)                19
2 GUARANTEED/INSURED LOAN (F)     1</code></pre>
</div>
</div>
<p>There are a few - what I can only assume, anyways - errors with some award types. Out of 100+ million rows, 20 of them have the type “DO,” and exactly one award has the type “DCA.” Out of curiosity, I had to know what that one record was.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dca_award <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(award_type <span class="sc">==</span> <span class="st">"DCA"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It was “awarded” to the National Academy of Sciences of the District of Columbia for the amount of -$16,830.09 with the description of “IGF::CL::IGF PROFESSIONAL SERVICES ARE REQUESTED BY FIMA, OPPA AND ICPD TO ASSIST THE GOVERNEMENT IN COMMUNITY RESILIENCE.” I like the idea of assisting the “government in community resilience” by withdrawing award funds, but anyways:</p>
<p>The discrepancies between grants and loans are important to differentiate from, so we want to keep them. You can find exact definition at the <a href="https://www.usaspending.gov/data-dictionary">Data Dictionary at usaspending.gov</a>, but to describe them in layman terms:</p>
<ul>
<li><strong>Block Grant (A)</strong>: Grants that can be used at the recipient’s discretion.</li>
<li><strong>Formula Grant (A)</strong>: Grants that have been awarded based on a distribution formula for activities of a “continuing nature.”<br>
</li>
<li></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">award_type =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DIRECT LOAN (E)"</span> <span class="sc">~</span> <span class="st">"Loan"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"GUARANTEED/INSURED LOAN (F)"</span> <span class="sc">~</span> <span class="st">"Loan"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DIRECT PAYMENT FOR SPECIFIED USE, AS A SUBSIDY OR OTHER NON-REIMBURSABLE DIRECT FINANCIAL AID (C)"</span> <span class="sc">~</span> <span class="st">"Grant"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"PURCHASE ORDER"</span> <span class="sc">~</span> <span class="st">"Contract"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DEFINITIVE CONTRACT"</span> <span class="sc">~</span> <span class="st">"Contract"</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"PROJECT GRANT (B)"</span> <span class="sc">~</span> <span class="st">"Grant"</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"COOPERATIVE AGREEMENT (B)"</span> <span class="sc">~</span> <span class="st">"Grant"</span>,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"FORMULA GRANT (A)"</span> <span class="sc">~</span> <span class="st">"Grant"</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"BLOCK GRANT (A)"</span> <span class="sc">~</span> <span class="st">"Grant"</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DELIVERY ORDER"</span> <span class="sc">~</span> <span class="st">"Contract"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DIRECT PAYMENT WITH UNRESTRICTED USE (RETIREMENT, PENSION, VETERANS BENEFITS, ETC.) (D)"</span> <span class="sc">~</span> <span class="st">"Grant"</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"BPA CALL"</span> <span class="sc">~</span> <span class="st">"Contract"</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"OTHER REIMBURSABLE, CONTINGENT, INTANGIBLE, OR INDIRECT FINANCIAL ASSISTANCE"</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DO"</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DCA"</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">award_subtype =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DIRECT LOAN (E)"</span> <span class="sc">~</span> <span class="st">"Direct"</span>,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"GUARANTEED/INSURED LOAN (F)"</span> <span class="sc">~</span> <span class="st">"Insured"</span>,</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DIRECT PAYMENT FOR SPECIFIED USE, AS A SUBSIDY OR OTHER NON-REIMBURSABLE DIRECT FINANCIAL AID (C)"</span> <span class="sc">~</span> <span class="st">"Specified Use"</span>,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"PURCHASE ORDER"</span> <span class="sc">~</span> <span class="st">"Purchase"</span>,</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DEFINITIVE CONTRACT"</span> <span class="sc">~</span> <span class="st">"Definitive"</span>,</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"PROJECT GRANT (B)"</span> <span class="sc">~</span> <span class="st">"Project"</span>,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"COOPERATIVE AGREEMENT (B)"</span> <span class="sc">~</span> <span class="st">"Cooperative Agreement"</span>,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"FORMULA GRANT (A)"</span> <span class="sc">~</span> <span class="st">"Formula"</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"BLOCK GRANT (A)"</span> <span class="sc">~</span> <span class="st">"Block"</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DELIVERY ORDER"</span> <span class="sc">~</span> <span class="st">"Delivery Order"</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DIRECT PAYMENT WITH UNRESTRICTED USE (RETIREMENT, PENSION, VETERANS BENEFITS, ETC.) (D)"</span> <span class="sc">~</span> <span class="st">"Unspecified Use"</span>,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"BPA CALL"</span> <span class="sc">~</span> <span class="st">"BPA"</span>,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"OTHER REIMBURSABLE, CONTINGENT, INTANGIBLE, OR INDIRECT FINANCIAL ASSISTANCE"</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DO"</span> <span class="sc">~</span> <span class="st">"Other"</span>,</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>      award_type <span class="sc">==</span> <span class="st">"DCA"</span> <span class="sc">~</span> <span class="st">"Other"</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The more concerning part is the number of NA values, which is essential to understanding award amounts.</p>
<p>Loans and grants are broken down into different</p>
</section>
<section id="outlay-and-ussgl-amounts" class="level2">
<h2 class="anchored" data-anchor-id="outlay-and-ussgl-amounts">Outlay and USSGL Amounts</h2>
<p>As mentioned before, award recipients may not use all of their funds at once. Loans are sometimes paid back with interest, meaning some are “profitable” for the government. Others are forgiven.</p>
<p>The dataset includes a <code>transaction_obligated_amount</code>, which is the amount the recipient is entitled to, while the other columns represent incremental updates to each unique reward key. According to the directions, <code>transaction_obligated_amount</code> should be summed by itself, while the other three columns should be summed separately. Once again, <code>dplyr::summarise</code> makes this task simple.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(award_unique_key) <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">award_amount_obligated =</span> <span class="fu">sum</span>(transaction_obligated_amount),</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">award_amount_utilized =</span> <span class="fu">sum</span>(gross_outlay_amount_FYB_to_period_end, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">sum</span>(USSGL487200_downward_adj_prior_year_prepaid_undeliv_order_oblig, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">sum</span>(USSGL497200_downward_adj_of_prior_year_paid_deliv_orders_oblig, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="base-action-dates" class="level2">
<h2 class="anchored" data-anchor-id="base-action-dates">Base Action Dates</h2>
<p>These refer to the dates that each award entry was entered. We’re condensing these rows down, so we want the earliest base date along with the latest base date. Date types with <code>arrow</code> are quite intuitive to use; simply using <code>min</code> and <code>max</code> will solve this problem.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(award_unique_key) <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_action_date =</span> <span class="fu">min</span>(award_base_action_date),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">last_action_date =</span> <span class="fu">max</span>(award_latest_action_date),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="zip-codes" class="level2">
<h2 class="anchored" data-anchor-id="zip-codes">Zip Codes</h2>
<p><strong>What the hell is this, usaspending.gov</strong>?</p>
<p>Zip codes are notoriously one of the most annoying things to deal with in data, and they didn’t even <em>try</em> to use any sort of standard for this column. Most zip codes are listed as five digits, but a few are three, nine, some are even seven. Nine digit codes are fine, and so are five, but codes in-between need leading 0s. However, zip codes <em>under</em> five also need leading 0s, but only until it reaches a standard five digit code, because increasing all the way to nine wouldn’t be intuitive for use (for example, converting a 123 zip into 000000123 doesn’t make any sense).</p>
<p>Trying to do this in base <code>R</code> would be annoying and inefficient, requiring multiple <code>ifelse</code> statements, but various packages have been created to tackle our very issue.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp(/https:\/\/nathanstates\.com/);
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../license.html">License</a>
  </li>  
</ul>
    </div>   
      <div class="nav-footer-center">
        <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/nathanstates_">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://mastodon.social/@nathanstates_">
      <i class="bi bi-mastodon" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/Nathan-States">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
      </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="../../../about.html">About</a>
  </li>  
    <li class="nav-item">
    <a class="nav-link" href="../../../contact.html">Contact</a>
  </li>  
</ul>
    </div>
  </div>
</footer>



<script src="../../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>